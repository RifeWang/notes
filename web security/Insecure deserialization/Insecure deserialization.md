# Insecure deserialization

在本节中，我们将介绍什么是不安全的反序列化，并描述它是如何使网站遭受高危害性攻击的。我们将重点介绍典型的场景，并演示一些 PHP、Ruby 和 Java 反序列化的具体示例。最后也会介绍一些避免不安全的反序列化漏洞的方法。

![](https://raw.githubusercontent.com/RifeWang/images/master/web-security/deserialization.jpeg)

利用不安全的反序列化通常比较困难。然而，它有时比你想象的要简单得多。如果您不熟悉反序列化，那么本节将包含一些重要的背景信息，您应该首先熟悉这些信息。如果您已经了解反序列化的基础知识，那么可以直接跳到学习如何利用它。


## 什么是序列化

序列化是将复杂的数据结构（如对象及其字段）转换为“更扁平”的格式的过程，该格式的数据可以作为字节流序列发送和接收。序列化的数据让以下过程更简单：
- 将复杂数据写入进程间内存、文件或数据库
- 发送复杂数据，例如，通过网络或API调用，在应用程序的不同组件之间传递复杂数据

关键的是，当序列化一个对象时，其状态也将保持不变。换句话说，对象的属性及其赋值都会被保留。


### 序列化 vs 反序列化

反序列化是将字节流还原为与原始对象完全相同的副本的过程。然后，网站的逻辑就可以与这个反序列化的对象进行交互，就像与任何其他对象进行交互一样。

![](https://raw.githubusercontent.com/RifeWang/images/master/web-security/serialization-deserialization.jpeg)

许多编程语言提供对序列化的本地支持。具体如何序列化对象取决于具体语言。一些语言将对象序列化为二进制格式，而另一些语言则会序列化为具有不同程度的可读性的字符串格式。请注意，原始对象的所有属性都存储在序列化数据流中，包括所有私有字段。为了防止字段被序列化，必须在类声明中将其显式标记为"transient" 。

请注意，当使用不同的编程语言时，序列化可能被称为 marshalling（Ruby）或 pickling（Python），这些术语与“序列化”同义。


## 什么是不安全的反序列化

不安全的反序列化是指用户可控制的数据被网站反序列化。这会使攻击者能够操纵序列化的对象，以便将有害数据传递到应用程序代码中。

甚至可以用完全不同类的对象替换序列化对象。令人担忧的是，网站上任何可用的类的对象都将被反序列化和实例化，而不管这个类是不是预期的类。因此，不安全的反序列化有时被称为 "object injection" 对象注入漏洞。

一个意外类的对象可能会导致异常。不过，在此之前，损害可能已经造成。许多基于反序列化的攻击在反序列化结束之前就已经完成。这意味着可以攻击反序列化的过程本身，即使网站的功能不直接与恶意对象交互。因此，其逻辑基于强类型语言的网站也容易受到这些技术的攻击。


## 不安全的反序列化漏洞是如何出现的

不安全的反序列化出现通常是因为人们普遍缺乏对用户可控数据进行反序列化的危险程度的了解。理想情况下，根本不应该对用户输入进行反序列化。

有些网站所有者认为他们很安全，因为其会对反序列化的数据进行某种形式的附加检查。然而，这种方法通常是无效的，因为几乎不可能验证或预料到所有可能发生的情况。这些检查在根本上也是有缺陷的，因为它们依赖于在数据被反序列化后对其进行检查，在许多情况下，这对于防止攻击来说已经太晚了。

漏洞产生也可能是因为反序列化的对象通常被认为是可信的。特别是在使用二进制序列化格式的语言时，开发人员可能会认为用户无法有效地读取或操作数据。然而，尽管这可能需要更多努力，但攻击者利用二进制序列化对象的可能性与利用基于字符串的格式的可能性是一样的。

由于现代网站中存在大量依赖项，因此基于反序列化的攻击也成为可能。一个站点可能使用许多不同的库，每个库也都有自己的依赖项，这就产生了一个难以安全管理的存在大量类和方法的池子。由于攻击者可以创建这些类中的任何一个实例，因此很难预测可以对恶意数据调用哪些方法。如果攻击者能够将一长串意外的方法调用链接在一起，并将数据传递到与初始源完全无关的接收器中，则尤其如此。因此，几乎不可能预测到恶意数据的流动并堵塞每个潜在的漏洞。

简而言之，安全地反序列化不受信任的输入是不可能的。


## 不安全的反序列化会造成什么影响

不安全的反序列化的影响可能非常严重，因为它提供了一个切入点，从而导致攻击面大幅增加。它允许攻击者以有害的方式重用现有的应用程序代码，从而导致许多其他漏洞，比如远程代码执行.

即使在无法执行远程代码的情况下，不安全的反序列化也可能导致权限提升、访问任意文件和拒绝服务攻击。


## 如何利用不安全的反序列化漏洞

下文会有详细说明。


## 如何防止不安全的反序列化漏洞

一般来说，除非绝对必要，否则应该避免用户输入的反序列化。在许多情况下，防御其潜在的高危漏洞的难度超过了其带来的好处。

如果确实需要反序列化来自不受信任的源的数据，请采取强大的措施以确保数据未被篡改。例如，您可以实现一个数字签名来检查数据的完整性。但是，请记住，任何检查都必须在开始反序列化之前进行。否则，检查就没什么用处了。

如果可能，您应该避免使用通用的反序列化功能。这些方法的序列化数据包含了原始对象的所有属性，以及可能包含敏感信息的私有字段。相反，你应该创建自己特定类的序列化方法，以控制公开字段。

最后，请记住，该漏洞是用户输入的反序列化，而不是随后处理数据的工具链的存在。不要依赖于试图消除测试过程中识别的工具链，由于跨库依赖的存在，这是不切实际的。在任何给定的时间，公开记录的内存损坏漏洞也意味着应用程序可能会受到攻击。